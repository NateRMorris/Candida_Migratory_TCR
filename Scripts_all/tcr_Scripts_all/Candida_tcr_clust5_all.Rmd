---
title: "Candida_tcr_clust5"
author: "Nathan Morris"
date: "2023-10-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
data_dir <- "/Users/johnmorris/Desktop/Comp_Bio_MS_Weill_Cornell/Summer_2023/Betel Lab/Betel:Iliev Candida Project/Candida_Migratory_TCR_Project/Data/"

setwd(data_dir)
```

# 7. Cluster 5 Split TCR analysis

```{r}
seurat_Cluster5 <- readRDS(paste0(data_dir,"Cluster5_pseudotime_seurat.rds"))
```

And we get the object containing our filtered TCR data
```{r}
IGT27_TCR <- read.table("/Users/johnmorris/Desktop/Comp_Bio_MS_Weill_Cornell/Summer_2023/Betel Lab/Betel:Iliev Candida Project/Candida_Migratory_TCR_Project/Data/IGT27_for_analysis.tsv", header = TRUE, sep = "\t")
```

```{r}
#table(seurat_Cluster5$RNA_clusters)
DimPlot(seurat_Cluster5 , reduction = "umap_rna", group.by = "SCT_snn_res.0.6", split.by = "Infection") 
```

```{r}
table(seurat_Cluster5$SCT_snn_res.0.6, seurat_Cluster5$Infection)
```

From this, it seems that when Candida colonization happens, the clusters 2 and 3 appear.

```{r}
seurat_Cluster5@meta.data[["clonotype"]] <- IGT27_TCR$clonotype[match(rownames(seurat_Cluster5@meta.data), IGT27_TCR$Barcode)] 
seurat_Cluster5@meta.data[["paired_across_organ"]] <- IGT27_TCR$paired_across_organ[match(rownames(seurat_Cluster5@meta.data), IGT27_TCR$Barcode)] 
seurat_Cluster5@meta.data[["duplicate"]] <- IGT27_TCR$duplicate[match(rownames(seurat_Cluster5@meta.data), IGT27_TCR$Barcode)] 
```

```{r}
clonotype_counts <- table(seurat_Cluster5$clonotype)

# Create a new metadata column containing the frequency for each cell
seurat_Cluster5$clonotype_frequency <- clonotype_counts[seurat_Cluster5$clonotype]
```

```{r}
DimPlot(seurat_Cluster5 , reduction = "umap_rna", group.by = "SCT_snn_res.0.6", split.by = "Infection", shape.by = "paired_across_organ", pt.size = (seurat_Cluster5$clonotype_frequency)*0.6) + ggtitle("Cluster 5 - Color by Cluster, Size by # of Cells with same Clonotype, Shape by Migratory") + theme(plot.title = element_text(size = 7, face = "bold"))
```

```{r}
# This is only for the number of cells that are paired across organ for the Cluster 5 across all mice
clust_5 <- list()

base_clust5 <- data.frame(
  Barcode = seurat_Cluster5$cell_barcode,
  SCT_snn_res0.6 = seurat_Cluster5$SCT_snn_res.0.6,
  Mouse = seurat_Cluster5$Mouse,
  Organ = seurat_Cluster5$Organ,
  Duplicate = seurat_Cluster5$duplicate,
  Paired = seurat_Cluster5$paired_across_organ,
  clonotype = seurat_Cluster5$clonotype
)

base_clust5 <- base_clust5  %>%
  mutate(Mouse_New = ifelse(Mouse == "mouse0080", "Candida Infected Male", ifelse(Mouse == "mouse0081", "Candida Infected Female", ifelse(Mouse == "mouse0082", "No Infection Male", Mouse))))

metadata_df <- base_clust5[which(base_clust5$Paired == TRUE),]

ggplot(metadata_df, aes(x = factor(SCT_snn_res0.6)), fill = Organ) +
  geom_bar(aes(fill = Organ), colour = "grey") +
  facet_wrap(~ Mouse_New) +
  labs(x = "SCT_snn_res0.6", y = "Number of Cells") +
  theme_minimal() + ggtitle("Paired Clonotype Cells in Cluster 5 Sub-clusters")

ggplot(metadata_df, aes(x = factor(SCT_snn_res0.6), fill = Mouse_New)) +
  geom_bar(position = "dodge", colour = "grey") +
  labs(x = "SCT_snn_res0.6 - Cluster 5 Sub-clusters", y = "Number of Cells") +
  theme_minimal() + ggtitle("Paired Clonotype Cells in Cluster 5 Sub-clusters")
```

```{r}
clust_5 <- list()

metadata_df_dup <- base_clust5[which(base_clust5$Duplicate == TRUE),]

ggplot(metadata_df_dup, aes(x = factor(SCT_snn_res0.6)), fill = Organ) +
  geom_bar(aes(fill = Organ), colour = "grey") +
  facet_wrap(~ Mouse_New) +
  labs(x = "SCT_snn_res0.6", y = "Number of Cells") +
  theme_minimal() + ggtitle("Duplicate Clonotype Cells in Cluster 5 Sub-clusters")

ggplot(metadata_df_dup, aes(x = factor(SCT_snn_res0.6), fill = Mouse_New)) +
  geom_bar(position = "dodge", colour = "grey") +
  labs(x = "SCT_snn_res0.6 - Cluster 5 Sub-clusters", y = "Number of Cells") +
  theme_minimal() + ggtitle("Duplicate Clonotype Cells in Cluster 5 Sub-clusters")
```

Finding the percentage of cells that are paired and duplicate in each of the subclusters. 
However, we see that we take only the cells from Cluster 5 that have TCR data to get the percentage of those with SPAIRED

```{r}
#table(seurat_Cluster5$SCT_snn_res.0.6, seurat_Cluster5$paired_across_organ, seurat_Cluster5$Infection)
table(seurat_Cluster5$SCT_snn_res.0.6, seurat_Cluster5$paired_across_organ, seurat_Cluster5$Mouse)

df_percentages <- base_clust5[which(!is.na(base_clust5$clonotype)),] %>%
  group_by(Mouse_New, SCT_snn_res0.6) %>%
  summarize(Paired_Percentage = mean(Paired, na.rm = TRUE) * 100,
            Duplicate_Percentage = mean(Duplicate, na.rm = TRUE) * 100)


ggplot(df_percentages, aes(x = SCT_snn_res0.6, y = Paired_Percentage, fill = Mouse_New)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "SCT_snn_res0.6 - Cluster 5 Sub-clusters", y = "Percentage (%)") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  #facet_wrap(~Mouse_New, ncol = 3) +
  ggtitle("Percentage of Paired Barcodes by SCT_snn_res0.6") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(df_percentages, aes(x = SCT_snn_res0.6, y = Duplicate_Percentage, fill = Mouse_New)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "SCT_snn_res0.6 - Cluster 5 Sub-clusters", y = "Percentage (%)") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  #facet_wrap(~Mouse_New, ncol = 3) +
  ggtitle("Percentage of Duplicate Barcodes by SCT_snn_res0.6") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

```{r}
# Percentage Check
poo <- base_clust5[which(!is.na(base_clust5$clonotype)),]
perc_check <- (nrow(poo[which(poo$SCT_snn_res0.6 == 2 & poo$Mouse_New == "No Infection Male" & poo$Paired == TRUE),]))/
(nrow(poo[which(poo$SCT_snn_res0.6 == 2 & poo$Mouse_New == "No Infection Male"),]))
perc_check1 <- (nrow(poo[which(poo$SCT_snn_res0.6 == 2 & poo$Mouse_New == "No Infection Male" & poo$Duplicate == TRUE),]))/
(nrow(poo[which(poo$SCT_snn_res0.6 == 2 & poo$Mouse_New == "No Infection Male"),]))

perc_check
perc_check1

df_percentages[which(df_percentages$Mouse_New == "No Infection Male" & df_percentages$SCT_snn_res0.6 == 2),]

```